const object = [
  {
    kind: "youtube#searchResult",
    etag: "icdlqaYyfDiV_JFP8YYAV1VPnYQ",
    id: {
      kind: "youtube#video",
      videoId: "34Na4j8AVgA",
    },
    snippet: {
      publishedAt: "2016-09-28T16:00:01Z",
      channelId: "UCF_fDSgPpBQuh1MsUTgIARQ",
      title: "The Weeknd - Starboy ft. Daft Punk (Official Video)",
      description:
        "Starboy ft. Daft Punk (Official Video) Taken from the new album Starboy http://theweeknd.co/StarboyYD Connect with The ...",
      thumbnails: {
        default: {
          url: "https://i.ytimg.com/vi/34Na4j8AVgA/default.jpg",
          width: 120,
          height: 90,
        },
        medium: {
          url: "https://i.ytimg.com/vi/34Na4j8AVgA/mqdefault.jpg",
          width: 320,
          height: 180,
        },
        high: {
          url: "https://i.ytimg.com/vi/34Na4j8AVgA/hqdefault.jpg",
          width: 480,
          height: 360,
        },
      },
      channelTitle: "TheWeekndVEVO",
      liveBroadcastContent: "none",
      publishTime: "2016-09-28T16:00:01Z",
    },
  },
  {
    kind: "youtube#searchResult",
    etag: "Nk14f3GUwMBpNM78InrsFtlp3zw",
    id: {
      kind: "youtube#video",
      videoId: "Rif-RTvmmss",
    },
    snippet: {
      publishedAt: "2023-03-14T23:34:20Z",
      channelId: "UCF_fDSgPpBQuh1MsUTgIARQ",
      title: "The Weeknd - Starboy (Audio) ft. Daft Punk",
      description:
        "Music video by The Weeknd performing Starboy (Audio). © 2023 The Weeknd XO, Inc., Manufactured and Marketed by Republic ...",
      thumbnails: {
        default: {
          url: "https://i.ytimg.com/vi/Rif-RTvmmss/default.jpg",
          width: 120,
          height: 90,
        },
        medium: {
          url: "https://i.ytimg.com/vi/Rif-RTvmmss/mqdefault.jpg",
          width: 320,
          height: 180,
        },
        high: {
          url: "https://i.ytimg.com/vi/Rif-RTvmmss/hqdefault.jpg",
          width: 480,
          height: 360,
        },
      },
      channelTitle: "TheWeekndVEVO",
      liveBroadcastContent: "none",
      publishTime: "2023-03-14T23:34:20Z",
    },
  },
  {
    kind: "youtube#searchResult",
    etag: "qZ7RSTcrw_9NomkQOZkuHZf87gA",
    id: {
      kind: "youtube#video",
      videoId: "plnfIj7dkJE",
    },
    snippet: {
      publishedAt: "2018-04-19T12:00:05Z",
      channelId: "UClYV6hHlupm_S_ObS1W-DYw",
      title: "Starboy",
      description:
        "Provided to YouTube by Universal Music Group Starboy · The Weeknd · Daft Punk Starboy ℗ 2016 The Weeknd XO, Inc., ...",
      thumbnails: {
        default: {
          url: "https://i.ytimg.com/vi/plnfIj7dkJE/default.jpg",
          width: 120,
          height: 90,
        },
        medium: {
          url: "https://i.ytimg.com/vi/plnfIj7dkJE/mqdefault.jpg",
          width: 320,
          height: 180,
        },
        high: {
          url: "https://i.ytimg.com/vi/plnfIj7dkJE/hqdefault.jpg",
          width: 480,
          height: 360,
        },
      },
      channelTitle: "The Weeknd - Topic",
      liveBroadcastContent: "none",
      publishTime: "2018-04-19T12:00:05Z",
    },
  },
  {
    kind: "youtube#searchResult",
    etag: "EFF5tgcLCm_d5ILY9Abr59XxHms",
    id: {
      kind: "youtube#video",
      videoId: "bwftFAk2DYQ",
    },
    snippet: {
      publishedAt: "2023-05-04T14:00:07Z",
      channelId: "UC01h45pIis5edhVebmFCY7Q",
      title: "Starboy Bob x AG - Neljapäevak (Official video)",
      description:
        "Sõnad: STARBOY BOB & AG Mix & Master: Jaanus Saks Biit: Papapedro Tootja: Mustu Films Režissöör: Kenneth Rüütli ...",
      thumbnails: {
        default: {
          url: "https://i.ytimg.com/vi/bwftFAk2DYQ/default.jpg",
          width: 120,
          height: 90,
        },
        medium: {
          url: "https://i.ytimg.com/vi/bwftFAk2DYQ/mqdefault.jpg",
          width: 320,
          height: 180,
        },
        high: {
          url: "https://i.ytimg.com/vi/bwftFAk2DYQ/hqdefault.jpg",
          width: 480,
          height: 360,
        },
      },
      channelTitle: "STARBOY BOB",
      liveBroadcastContent: "none",
      publishTime: "2023-05-04T14:00:07Z",
    },
  },
  {
    kind: "youtube#searchResult",
    etag: "NIOUYNzgHY49t6b_Wy58ps3GXmU",
    id: {
      kind: "youtube#video",
      videoId: "xizN47Box_Y",
    },
    snippet: {
      publishedAt: "2020-01-19T16:46:53Z",
      channelId: "UCNqFDjYTexJDET3rPDrmJKg",
      title: "The Weeknd - Starboy (Lyrics) ft. Daft Punk",
      description:
        "Follow our Spotify playlists: http://bit.ly/7cloudsSpotify The Weeknd - Starboy (Lyrics) ft. Daft Punk ⏬ Download / Stream: ...",
      thumbnails: {
        default: {
          url: "https://i.ytimg.com/vi/xizN47Box_Y/default.jpg",
          width: 120,
          height: 90,
        },
        medium: {
          url: "https://i.ytimg.com/vi/xizN47Box_Y/mqdefault.jpg",
          width: 320,
          height: 180,
        },
        high: {
          url: "https://i.ytimg.com/vi/xizN47Box_Y/hqdefault.jpg",
          width: 480,
          height: 360,
        },
      },
      channelTitle: "7clouds",
      liveBroadcastContent: "none",
      publishTime: "2020-01-19T16:46:53Z",
    },
  },
];

window.onload = onWindowLoad;

let clickBtn = document.getElementById("click-btn");
let heading = document.getElementById("heading");
let list = document.getElementById("list");
list.innerHTML = `<h2>Loading...</h2>`;

const fetchData = async (searchTerm) => {
  const response = await fetch(
    `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${searchTerm}&type=video&key=AIzaSyC71ixwqTk-VKDVWRbBcwTG_dkSAHSIuQw`
  );
  const resjson = await response.json();
  const data = resjson.items;
  displayList(data);
};

function onWindowLoad() {
  chrome.permissions.contains(
    {
      permissions: ["scripting", "activeTab", "tabs"],
    },
    (result) => {
      if (result) {
        chrome.tabs
          .query({ active: true, currentWindow: true })
          .then(function (tabs) {
            var activeTab = tabs[0];
            var activeTabId = activeTab.id;

            return chrome.scripting.executeScript({
              target: { tabId: activeTabId },
              func: DOMtoString,
              args: ["title", "h1", "h2", "h3"],
            });
          })
          .then(function (results) {
            // displayList(object);
            let searchTerm = results[0].result;
            fetchData(searchTerm);
          })
          .catch(function (error) {
            heading.innerText =
              "There was an error injecting script : \n" + error.message;
          });
      } else {
        heading.innerHTML = "NOT GRANTED";
      }
    }
  );
}

const displayList = (displayList) => {
  let listItems = "";
  displayList.map(
    (item) =>
      (listItems += `
  <div class="item">
    <a target='_black' href="https://www.youtube.com/watch?v=${item.id.videoId}">
      <img src="${item.snippet.thumbnails.medium.url}" alt="Video Thumbnail" width="320" height="180">
      <h2>${item.snippet.title}</h2>
    </a>
    <h3>${item.snippet.channelTitle}</h3>
  </div>
  `)
  );
  list.innerHTML = listItems;
};

const DOMtoString = (selector, selector1, selector2, selector3) => {
  if (selector || selector1 || selector2 || selector3) {
    selector = document.querySelector(selector);
    selector1 = document.querySelector(selector1);
    selector2 = document.querySelectorAll(selector2);
    selector3 = document.querySelectorAll(selector3);
    if (!selector && !selector1 && !selector2 && !selector3)
      return "No node found";
  } else {
    selector = document.documentElement;
    selector1 = document.documentElement;
    selector2 = document.documentElement;
    selector3 = document.documentElement;
  }

  let h2Terms = [];
  let h3Terms = [];

  selector2.forEach((item) => h2Terms.push(item.innerText));
  selector3.forEach((item) => h3Terms.push(item.innerText));

  return selector.innerText;
  // return [selector.innerText, selector1.innerText];
  // return [selector.innerText, selector1.innerText, h2Terms, h3Terms];
};
